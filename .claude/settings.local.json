{
  "permissions": {
    "allow": [
      "Bash(git checkout:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(gh pr create --title \"Secure webhook endpoint and refactor subscription handling\" --body \"$\\(cat <<''EOF''\n## Summary\n- **Webhook signature verification**: Added HMAC-SHA256 verification using `X-Signature` header and `LEMON_SQUEEZY_WEBHOOK_SECRET` env var â€” rejects forged webhooks with 401\n- **Fixed missing `payment-success` socket emission**: The handler had a console.log but no actual `io.to\\(\\).emit\\(\\)` call\n- **Added `status` field to Subscription model**: Tracks subscription state \\(`active`, `cancelled`, etc.\\) so cancellations preserve history instead of deleting records\n- **Replaced external API call with local DB check**: `is-user-subscribed.ts` now queries MongoDB instead of calling the Lemon Squeezy API on every link creation\n- **Null safety**: Added guards to `deleteSubscriptionHandler` to prevent crashes when no subscription exists\n\n## Test plan\n- [ ] Add `LEMON_SQUEEZY_WEBHOOK_SECRET` to `.env` \\(from Lemon Squeezy dashboard webhook settings\\)\n- [ ] Send a webhook to `/api/webhook` without a valid signature â€” should get 401\n- [ ] Test subscription creation via Lemon Squeezy â€” subscription created with `status: active`\n- [ ] Verify `payment-success` socket event arrives on frontend\n- [ ] Test cancellation â€” subscription updates to `status: cancelled`, `linksAllowed: 0` instead of being deleted\n- [ ] Test link creation â€” verify no external API calls, local DB status check works\n\nðŸ¤– Generated with [Claude Code]\\(https://claude.com/claude-code\\)\nEOF\n\\)\")"
    ]
  }
}
